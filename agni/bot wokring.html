<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AGNI V3</title>
<script src="https://cdn.jsdelivr.net/npm/livekit-client@2.9.1/dist/livekit-client.umd.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600&family=Outfit:wght@300;400&display=swap');

  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --ember: #e8531e;
    --fire-gold: #f5a623;
    --dark-bg: #1a1210;
    --card-bg: #1e1814;
    --card-border: #3a2a20;
    --text-dim: #8a7568;
    --text-light: #c4b5a8;
  }

  body {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--dark-bg);
    font-family: 'Outfit', sans-serif;
    overflow: hidden;
  }

  /* ── Ember particle canvas ── */
  .ember-bg {
    position: fixed;
    inset: 0;
    z-index: 0;
    pointer-events: none;
  }

  /* ── Main Widget Card ── */
  .widget-card {
    position: relative;
    z-index: 1;
    width: 420px;
    max-width: 94vw;
    aspect-ratio: 1 / 1.05;
    background: var(--card-bg);
    border-radius: 24px;
    border: 1px solid var(--card-border);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    box-shadow:
      0 0 80px rgba(232, 83, 30, 0.08),
      0 30px 60px rgba(0,0,0,0.5),
      inset 0 1px 0 rgba(255,255,255,0.03);
  }

  /* Lava border glow */
  .widget-card::before {
    content: '';
    position: absolute;
    inset: -2px;
    border-radius: 26px;
    background: linear-gradient(
      135deg,
      rgba(232, 83, 30, 0.4) 0%,
      transparent 30%,
      transparent 70%,
      rgba(245, 166, 35, 0.3) 100%
    );
    z-index: -1;
    opacity: 0.6;
  }

  /* Noise texture overlay */
  .widget-card::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 24px;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 10;
  }

  /* ── Version label ── */
  .version-label {
    position: absolute;
    top: 24px;
    left: 28px;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 500;
    font-size: 13px;
    letter-spacing: 3px;
    color: var(--text-dim);
    text-transform: uppercase;
  }

  /* ── LIVE badge ── */
  .live-badge {
    position: absolute;
    bottom: 24px;
    right: 28px;
    display: flex;
    align-items: center;
    gap: 7px;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 500;
    font-size: 13px;
    letter-spacing: 3px;
    color: var(--text-dim);
    text-transform: uppercase;
    opacity: 0;
    transition: opacity 0.5s ease;
  }
  .live-badge.visible { opacity: 1; }

  .live-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #e53935;
    box-shadow: 0 0 8px #e53935;
    animation: livePulse 1.5s ease-in-out infinite;
  }

  @keyframes livePulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.85); }
  }

  /* ── Orb Container ── */
  .orb-container {
    position: relative;
    width: 220px;
    height: 220px;
    cursor: pointer;
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .orb-container:hover { transform: scale(1.04); }
  .orb-container:active { transform: scale(0.97); }

  /* Glass orb shell */
  .orb-shell {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: radial-gradient(
      circle at 35% 30%,
      rgba(255,255,255,0.08) 0%,
      rgba(255,255,255,0.02) 40%,
      transparent 70%
    );
    border: 1px solid rgba(255,255,255,0.06);
    box-shadow:
      inset 0 0 40px rgba(232, 83, 30, 0.15),
      0 0 60px rgba(232, 83, 30, 0.12),
      0 0 120px rgba(232, 83, 30, 0.06);
    z-index: 2;
    pointer-events: none;
  }

  /* Fire image */
  .fire-image {
    position: absolute;
    inset: 15px;
    border-radius: 50%;
    overflow: hidden;
    z-index: 1;
  }
  .fire-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
  }

  /* Video container (hidden initially) */
  .video-container {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    overflow: hidden;
    z-index: 3;
    opacity: 0;
    transition: opacity 0.6s ease;
    pointer-events: none;
  }
  .video-container.active {
    opacity: 1;
    pointer-events: auto;
  }
  .video-container video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Ambient glow behind orb */
  .orb-glow {
    position: absolute;
    inset: -30px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(232, 83, 30, 0.18) 0%, transparent 70%);
    z-index: 0;
    animation: glowBreath 3s ease-in-out infinite;
  }
  @keyframes glowBreath {
    0%, 100% { opacity: 0.6; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.08); }
  }

  /* ── Text Elements ── */
  .tap-text {
    margin-top: 32px;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 400;
    font-size: 20px;
    letter-spacing: 6px;
    color: var(--text-light);
    text-transform: lowercase;
    transition: all 0.4s ease;
  }

  .tagline {
    margin-top: 10px;
    font-family: 'Outfit', sans-serif;
    font-weight: 300;
    font-size: 13px;
    letter-spacing: 1.5px;
    color: var(--text-dim);
    transition: all 0.4s ease;
  }

  /* ── Loading State ── */
  .loading-ring {
    position: absolute;
    inset: -6px;
    border-radius: 50%;
    border: 2px solid transparent;
    border-top-color: var(--ember);
    border-right-color: var(--fire-gold);
    z-index: 5;
    opacity: 0;
    animation: none;
    pointer-events: none;
  }
  .loading-ring.active {
    opacity: 1;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ── Connected state ── */
  .widget-card.connected .orb-glow {
    animation: glowBreathActive 2s ease-in-out infinite;
  }
  @keyframes glowBreathActive {
    0%, 100% { opacity: 0.7; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.12); }
  }

  /* ── Audio Visualizer Ring ── */
  .audio-ring {
    position: absolute;
    inset: -12px;
    border-radius: 50%;
    z-index: 4;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.5s ease;
  }
  .audio-ring.active { opacity: 1; }
  .audio-ring canvas {
    width: 100%;
    height: 100%;
  }

  /* ── End call button ── */
  .end-call-btn {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(229, 57, 53, 0.15);
    border: 1px solid rgba(229, 57, 53, 0.3);
    color: #e53935;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 500;
    font-size: 12px;
    letter-spacing: 3px;
    text-transform: uppercase;
    padding: 8px 24px;
    border-radius: 20px;
    cursor: pointer;
    opacity: 0;
    pointer-events: none;
    transition: all 0.4s ease;
    z-index: 11;
  }
  .end-call-btn.visible {
    opacity: 1;
    pointer-events: auto;
  }
  .end-call-btn:hover {
    background: rgba(229, 57, 53, 0.25);
    box-shadow: 0 0 20px rgba(229, 57, 53, 0.2);
  }

  /* ── Subtle scan line effect ── */
  .scanlines {
    position: absolute;
    inset: 0;
    border-radius: 24px;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.015) 2px,
      rgba(0,0,0,0.015) 4px
    );
    pointer-events: none;
    z-index: 9;
  }

  /* ── Status text ── */
  .status-text {
    position: absolute;
    bottom: 60px;
    font-family: 'Outfit', sans-serif;
    font-size: 12px;
    color: var(--text-dim);
    letter-spacing: 1px;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 11;
  }
  .status-text.visible { opacity: 1; }
</style>
</head>
<body>

<canvas class="ember-bg" id="emberCanvas"></canvas>

<div class="widget-card" id="widgetCard">
  <span class="version-label">AGNI V3</span>

  <div class="orb-container" id="orbContainer">
    <div class="orb-glow"></div>
    <div class="fire-image" id="fireImage">
      <img src="https://storage.googleapis.com/msgsndr/LK2LrQP5tkIZ3ahmumnr/media/698928520708e4d8649f0642.png" alt="Agni Fire" crossorigin="anonymous">
    </div>
    <div class="video-container" id="videoContainer">
      <video id="agentVideo" playsinline muted loop></video>
    </div>
    <div class="orb-shell"></div>
    <div class="loading-ring" id="loadingRing"></div>
    <div class="audio-ring" id="audioRing">
      <canvas id="audioCanvas"></canvas>
    </div>
  </div>

  <div class="tap-text" id="tapText">tap to talk</div>
  <div class="tagline" id="tagline">experience agni — no signup</div>

  <span class="status-text" id="statusText"></span>
  <button class="end-call-btn" id="endCallBtn">End Call</button>

  <div class="live-badge" id="liveBadge">
    <span class="live-dot"></span>
    LIVE
  </div>

  <div class="scanlines"></div>
</div>

<script>
(() => {
  // ── Config ──
  const API_URL = 'https://app.snowie.ai/api/create-room/';
  const PAYLOAD = {
    agent_code: '8b44f4dc-19ce-4dcc-9f5b-1d639dc45ef6',
    provider: 'thunderemotionlite',
    schema_name: '6af30ad4-a50c-4acc-8996-d5f562b6987f'
  };
  const VIDEO_URL = 'https://storage.googleapis.com/msgsndr/LK2LrQP5tkIZ3ahmumnr/media/6989285267d749bf9ff413c4.mp4';

  // ── DOM refs ──
  const orbContainer = document.getElementById('orbContainer');
  const loadingRing = document.getElementById('loadingRing');
  const videoContainer = document.getElementById('videoContainer');
  const agentVideo = document.getElementById('agentVideo');
  const tapText = document.getElementById('tapText');
  const tagline = document.getElementById('tagline');
  const liveBadge = document.getElementById('liveBadge');
  const endCallBtn = document.getElementById('endCallBtn');
  const statusText = document.getElementById('statusText');
  const widgetCard = document.getElementById('widgetCard');
  const audioCanvas = document.getElementById('audioCanvas');
  const audioRing = document.getElementById('audioRing');

  let room = null;
  let isConnected = false;
  let isConnecting = false;
  let audioCtx = null;
  let analyser = null;
  let animFrameId = null;

  // ── Show status ──
  function setStatus(msg) {
    statusText.textContent = msg;
    statusText.classList.toggle('visible', !!msg);
  }

  // ── Ember background particles ──
  function initEmbers() {
    const canvas = document.getElementById('emberCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resize();
    window.addEventListener('resize', resize);

    class Ember {
      constructor() { this.reset(); }
      reset() {
        this.x = Math.random() * canvas.width;
        this.y = canvas.height + 10;
        this.size = Math.random() * 2.5 + 0.5;
        this.speedY = -(Math.random() * 0.6 + 0.2);
        this.speedX = (Math.random() - 0.5) * 0.3;
        this.opacity = Math.random() * 0.5 + 0.2;
        this.life = Math.random() * 200 + 100;
        this.age = 0;
        const colors = ['#e8531e', '#f5a623', '#ff6b35', '#d4421a'];
        this.color = colors[Math.floor(Math.random() * colors.length)];
      }
      update() {
        this.x += this.speedX + Math.sin(this.age * 0.02) * 0.2;
        this.y += this.speedY;
        this.age++;
        this.opacity = Math.max(0, this.opacity - 0.001);
        if (this.age > this.life || this.y < -10) this.reset();
      }
      draw() {
        ctx.save();
        ctx.globalAlpha = this.opacity;
        ctx.fillStyle = this.color;
        ctx.shadowColor = this.color;
        ctx.shadowBlur = this.size * 3;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
      }
    }

    for (let i = 0; i < 40; i++) {
      const e = new Ember();
      e.y = Math.random() * canvas.height;
      particles.push(e);
    }

    function loop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach(p => { p.update(); p.draw(); });
      requestAnimationFrame(loop);
    }
    loop();
  }
  initEmbers();

  // ── Audio visualizer ring ──
  function initAudioVisualizer(audioTrack) {
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const stream = new MediaStream([audioTrack.mediaStreamTrack]);
      const source = audioCtx.createMediaStreamSource(stream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 128;
      source.connect(analyser);

      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      const canvasEl = audioCanvas;
      const ctx = canvasEl.getContext('2d');
      const size = 244;
      canvasEl.width = size;
      canvasEl.height = size;

      audioRing.classList.add('active');

      function drawRing() {
        animFrameId = requestAnimationFrame(drawRing);
        analyser.getByteFrequencyData(dataArray);
        ctx.clearRect(0, 0, size, size);

        const cx = size / 2, cy = size / 2, radius = size / 2 - 10;
        const bars = bufferLength;

        for (let i = 0; i < bars; i++) {
          const angle = (i / bars) * Math.PI * 2 - Math.PI / 2;
          const val = dataArray[i] / 255;
          const barH = val * 18 + 2;

          const x1 = cx + Math.cos(angle) * radius;
          const y1 = cy + Math.sin(angle) * radius;
          const x2 = cx + Math.cos(angle) * (radius + barH);
          const y2 = cy + Math.sin(angle) * (radius + barH);

          ctx.beginPath();
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
          ctx.strokeStyle = `rgba(232, 83, 30, ${0.3 + val * 0.7})`;
          ctx.lineWidth = 2;
          ctx.lineCap = 'round';
          ctx.stroke();
        }
      }
      drawRing();
    } catch (e) {
      console.warn('Audio visualizer error:', e);
    }
  }

  function stopAudioVisualizer() {
    if (animFrameId) cancelAnimationFrame(animFrameId);
    if (audioCtx) { audioCtx.close(); audioCtx = null; }
    audioRing.classList.remove('active');
  }

  // ── Connect to LiveKit ──
  async function connectToRoom() {
    if (isConnecting || isConnected) return;
    isConnecting = true;

    loadingRing.classList.add('active');
    tapText.textContent = 'connecting...';
    tagline.style.opacity = '0.4';
    setStatus('Creating room...');

    try {
      // 1. Call API to create room
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(PAYLOAD)
      });
      const data = await res.json();

      if (!data.success || !data.response?.token) {
        throw new Error(data.message || 'Failed to create room');
      }

      const { token, url } = data.response;

      setStatus('Connecting to agent...');

      // 2. Connect to LiveKit room
      const LivekitClient = window.LivekitClient;
      room = new LivekitClient.Room({
        adaptiveStream: true,
        dynacast: true,
        videoCaptureDefaults: { resolution: LivekitClient.VideoPresets.h720.resolution }
      });

      // Handle remote tracks (agent video/audio)
      room.on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
        console.log('Track subscribed:', track.kind, track.source);
        if (track.kind === 'video') {
          track.attach(agentVideo);
          agentVideo.muted = false;
          videoContainer.classList.add('active');
        }
        if (track.kind === 'audio') {
          const audioEl = track.attach();
          document.body.appendChild(audioEl);
          initAudioVisualizer(track);
        }
      });

      room.on(LivekitClient.RoomEvent.TrackUnsubscribed, (track) => {
        track.detach().forEach(el => el.remove());
      });

      room.on(LivekitClient.RoomEvent.Disconnected, () => {
        handleDisconnect();
      });

      room.on(LivekitClient.RoomEvent.ParticipantConnected, (participant) => {
        console.log('Participant connected:', participant.identity);
        setStatus('');
      });

      // Connect
      await room.connect(url, token);
      console.log('Connected to room:', room.name);

      // 3. Publish local microphone
      try {
        await room.localParticipant.setMicrophoneEnabled(true);
      } catch (micErr) {
        console.warn('Microphone access denied:', micErr);
        setStatus('Mic access needed for voice');
      }

      // Show idle video while waiting for agent
      agentVideo.src = VIDEO_URL;
      agentVideo.muted = true;
      agentVideo.play().catch(() => {});
      videoContainer.classList.add('active');

      // Update UI
      isConnected = true;
      isConnecting = false;
      loadingRing.classList.remove('active');
      widgetCard.classList.add('connected');
      tapText.textContent = 'speaking...';
      tagline.style.opacity = '0';
      liveBadge.classList.add('visible');
      endCallBtn.classList.add('visible');
      setStatus('');

    } catch (err) {
      console.error('Connection error:', err);
      isConnecting = false;
      loadingRing.classList.remove('active');
      tapText.textContent = 'tap to talk';
      tagline.style.opacity = '1';
      setStatus('Connection failed. Tap to retry.');
      setTimeout(() => setStatus(''), 3000);
    }
  }

  // ── Disconnect ──
  function handleDisconnect() {
    if (room) {
      room.disconnect();
      room = null;
    }
    stopAudioVisualizer();
    isConnected = false;
    isConnecting = false;

    videoContainer.classList.remove('active');
    agentVideo.srcObject = null;
    agentVideo.src = '';
    widgetCard.classList.remove('connected');
    liveBadge.classList.remove('visible');
    endCallBtn.classList.remove('visible');
    tapText.textContent = 'tap to talk';
    tagline.style.opacity = '1';
    setStatus('');

    // Remove any attached audio elements
    document.querySelectorAll('audio').forEach(el => el.remove());
  }

  // ── Event listeners ──
  orbContainer.addEventListener('click', () => {
    if (isConnected) return;
    connectToRoom();
  });

  endCallBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    handleDisconnect();
  });
})();
</script>
</body>
</html>
